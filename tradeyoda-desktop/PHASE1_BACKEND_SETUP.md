# Phase 1: Backend Preparation for Desktop Packaging

## Overview
This phase prepares the TradeYoda backend for desktop packaging by implementing desktop-aware file paths and PyInstaller configuration.

## What Was Done

### 1. Desktop Configuration Module (`src/utils/desktop_config.py`)
Created a comprehensive module to handle desktop-specific paths and configurations:

**Features:**
- **OS-Specific App Data Directories:**
  - Windows: `C:\Users\{username}\AppData\Roaming\TradeYoda`
  - macOS: `~/Library/Application Support/TradeYoda`
  - Linux: `~/.tradeyoda`

- **First-Run Detection:** Checks if license key or config file exists
- **Path Management:** Handles paths for data, logs, cache, config files
- **Resource Loading:** Works for both development and packaged modes
- **Default Files:** Copies default files (scrip master, credentials) on first run

### 2. Updated Existing Modules
Modified existing code to use desktop-aware paths:

**Files Updated:**
- `src/config.py` - Uses `desktop_config` for BASE_DIR, DATA_DIR, LOGS_DIR
- `src/utils/licensing_client.py` - Uses `desktop_config.cache_dir` for license cache
- `src/utils/security_master.py` - Uses `desktop_config.scrip_master_file` in desktop mode
- `src/utils/credentials_store.py` - Already uses DATA_DIR (now desktop-aware)

### 3. PyInstaller Configuration (`tradeyoda-backend.spec`)
Created PyInstaller spec file with:
- All required dependencies (FastAPI, uvicorn, dhanhq, pandas, etc.)
- Data files (scrip master CSV, source files)
- Hidden imports for dynamic modules
- Optimized exclusions (matplotlib, tkinter, etc.)

### 4. Backend Entrypoint (`backend_entrypoint.py`)
Created startup script that:
- Detects first run
- Sets up app data directories
- Copies default files
- Starts FastAPI server on port 8000

### 5. Build Script (`build_backend.sh`)
Shell script to automate backend packaging:
- Cleans previous builds
- Runs PyInstaller with spec file
- Validates build output
- Provides testing instructions

## File Structure

```
/app/tradeyoda/
├── src/
│   └── utils/
│       └── desktop_config.py          # NEW: Desktop configuration
├── backend_entrypoint.py              # NEW: Desktop backend entrypoint
├── tradeyoda-backend.spec             # NEW: PyInstaller configuration
├── build_backend.sh                   # NEW: Build automation script
└── dist/
    └── tradeyoda-backend/             # Generated by build
        ├── tradeyoda-backend(.exe)    # Backend executable
        └── [dependencies]
```

## Data Storage in Desktop Mode

When running as desktop app, all data is stored in OS-specific locations:

### Windows
```
C:\Users\{username}\AppData\Roaming\TradeYoda\
├── config.json                 # App configuration
├── data/
│   ├── api-scrip-master.csv   # Securities data
│   └── credentials.json        # Dhan credentials
├── logs/
│   └── tradeyoda_*.log        # Application logs
└── cache/
    ├── .license_key            # License key
    └── .license_cache          # Cached validation
```

### macOS
```
~/Library/Application Support/TradeYoda/
├── config.json
├── data/
├── logs/
└── cache/
```

### Linux
```
~/.tradeyoda/
├── config.json
├── data/
├── logs/
└── cache/
```

## How It Works

### Mode Detection
The system automatically detects if it's running as:
1. **Packaged Desktop App:** `sys.frozen` is True (PyInstaller)
2. **Development/Web Mode:** Running from source code

### Path Resolution
```python
# In desktop mode
DATA_DIR = ~/Library/Application Support/TradeYoda/data

# In dev/web mode
DATA_DIR = /app/tradeyoda/data
```

### First Run Flow
1. App starts → checks for license key file
2. If not found → First run detected
3. Creates all directories
4. Copies default files from bundle
5. Ready for license activation

## Building the Backend

### Prerequisites
```bash
pip install pyinstaller
```

### Build Commands
```bash
cd /app/tradeyoda
./build_backend.sh
```

### Manual Build
```bash
cd /app/tradeyoda
pyinstaller tradeyoda-backend.spec --clean
```

### Output
```
dist/tradeyoda-backend/
├── tradeyoda-backend(.exe)    # Main executable
├── _internal/                  # Dependencies
│   ├── api-scrip-master.csv
│   ├── src/
│   └── [libraries]
└── [supporting files]
```

## Testing the Backend

### 1. Test Desktop Mode Detection
```bash
# Set desktop mode manually
export TRADEYODA_DESKTOP_MODE=true
python backend_entrypoint.py
```

### 2. Test Packaged Executable
```bash
cd dist/tradeyoda-backend
./tradeyoda-backend
```

### 3. Verify Paths
Check console output for:
- ✅ App Data Directory location
- ✅ First-run detection
- ✅ File copying status
- ✅ Server startup

### 4. Test API
```bash
# In another terminal
curl http://127.0.0.1:8000/health
```

Expected response:
```json
{
  "status": "healthy",
  "timestamp": "2025-01-19T...",
  "orchestrator_running": false
}
```

## Backward Compatibility

All changes are **100% backward compatible:**
- Web/dev mode works exactly as before
- No changes needed to existing deployment
- Desktop mode only activates when packaged

## Next Steps

After completing Phase 1:
1. ✅ Backend paths are desktop-aware
2. ✅ PyInstaller configuration ready
3. ✅ Build script automated

**Ready for Phase 2:** Electron setup and frontend integration

## Troubleshooting

### Build Fails
```bash
# Install missing dependencies
pip install -r requirements.txt
pip install pyinstaller
```

### Import Errors in Packaged App
Add missing imports to `hiddenimports` in `tradeyoda-backend.spec`

### Path Issues
Check `desktop_config.is_desktop_mode` returns True in packaged app

### First Run Not Detected
Delete test files:
```bash
rm -rf ~/Library/Application\ Support/TradeYoda
# or on Windows
del /s "C:\Users\{username}\AppData\Roaming\TradeYoda"
```

## Notes

- **Port:** Backend runs on `127.0.0.1:8000` (not 8001)
- **Logs:** Console logs shown in terminal when running executable
- **Data Persistence:** All user data survives app updates
- **Security:** License keys and credentials stored in OS user directory
